<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>USMC Training Portal</title>
<style>
body { margin:0; font-family:Arial, sans-serif; background:#0f172a; color:#e5e7eb; }
header { background:#020617; padding:15px; text-align:center; font-weight:bold; }
input, select, button, textarea { width:100%; padding:6px; margin:3px 0; border-radius:6px; border:none; }
button { background:#1d4ed8; color:white; cursor:pointer; }
button:hover { background:#2563eb; }
.card { background:#020617; padding:15px; margin:10px; border-radius:10px; }
.nav { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
.nav button { flex:1; }
.hidden { display:none; }
.avatar { width:80px; border-radius:50%; border:2px solid #1d4ed8; }
.schedule-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:5px; }
.schedule-cell { background:#131b2b; padding:5px; border-radius:6px; min-height:50px; position:relative; }
.schedule-lesson { background:#1d4ed8; margin:2px 0; padding:2px 4px; border-radius:4px; font-size:12px; cursor:pointer; }
.delete-btn { position:absolute; top:2px; right:2px; background:red; border:none; color:white; font-size:10px; border-radius:3px; cursor:pointer; }
.chat-message { background:#1e40af; padding:4px; margin:2px 0; border-radius:4px; font-size:12px; word-wrap: break-word; }
@media(max-width:768px){ .nav button{flex:100%;} .schedule-grid { grid-template-columns: repeat(1, 1fr); } }
</style>
</head>
<body>

<header>USMC ROBLOX TRAINING SYSTEM</header>

<div id="login" class="card">
<h2>Login</h2>
<input id="loginUser" placeholder="Username">
<input id="loginPass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<div id="app" class="hidden">
<div class="nav">
<button onclick="show('dashboard')">Dashboard</button>
<button onclick="show('schedule')">Schedule</button>
<button onclick="show('grades')">Grades</button>
<button onclick="show('chat')">Chat</button>
<button onclick="show('trainer')" id="trainerBtn">Trainer Panel</button>
<button onclick="show('admin')" id="adminBtn">Admin Panel</button>
<button onclick="logout()">Logout</button>
</div>

<div id="dashboard" class="card"></div>
<div id="schedule" class="card hidden"></div>
<div id="grades" class="card hidden"></div>
<div id="chat" class="card hidden"></div>
<div id="trainer" class="card hidden"></div>
<div id="admin" class="card hidden"></div>

<script>
// ------------------- Ranks -------------------
const RANKS = [
  {id: 1, name: "[RT] Recruit Training"},
  {id: 2, name: "[E1] Private"},
  {id: 3, name: "[E2] Private First Class"},
  {id: 4, name: "[E3] Lance Corporal"},
  {id: 5, name: "[E4] Corporal"},
  {id: 6, name: "[E5] Sergeant"},
  {id: 7, name: "[E6] Staff Sergeant"},
  {id: 8, name: "[E7] Gunnery Sergeant"},
  {id: 9, name: "[E8] Master Sergeant"},
  {id:10, name: "[E8] First Sergeant"},
  {id:11, name: "[E9] Master Gunnery Sergeant"},
  {id:12, name: "[E9] Sergeant Major"},
  {id:13, name: "[VIP] Very Important Person"},
  {id:14, name: "[O1] Second Lieutenant"},
  {id:15, name: "[O2] First Lieutenant"},
  {id:16, name: "[O3] Captain"},
  {id:17, name: "[O4] Major"},
  {id:18, name: "[O5] Lieutenant Colonel"},
  {id:19, name: "[O6] Colonel"},
  {id:20, name: "[O7] Brigadier General"},
  {id:21, name: "[O8] Major General"},
  {id:22, name: "[O9] Lieutenant General"},
  {id:23, name: "[O10] General"}
];

// ------------------- LocalStorage -------------------
let users = JSON.parse(localStorage.getItem('users')) || {
  "ADMIN60487753641": {password:"MARC60487753641", role:"Admin", robloxId:"60487753641", rank:23, rankName:"[O10] General", class:"HQ"}
};
let schedule = JSON.parse(localStorage.getItem('schedule')) || {};
let grades = JSON.parse(localStorage.getItem('grades')) || {};
let messages = JSON.parse(localStorage.getItem('messages')) || [];
let friends = JSON.parse(localStorage.getItem('friends')) || {};
let currentUser = null;
function save(){ 
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('schedule', JSON.stringify(schedule));
  localStorage.setItem('grades', JSON.stringify(grades));
  localStorage.setItem('messages', JSON.stringify(messages));
  localStorage.setItem('friends', JSON.stringify(friends));
}

// ------------------- Login / Logout -------------------
function login(){
 let u=document.getElementById('loginUser').value;
 let p=document.getElementById('loginPass').value;
 if(users[u] && users[u].password===p){
   currentUser=u;
   document.getElementById('login').classList.add('hidden');
   document.getElementById('app').classList.remove('hidden');
   loadUI();
 } else alert('Invalid credentials');
}
function logout(){ location.reload(); }
function show(id){
 document.querySelectorAll('#app .card').forEach(c=>c.classList.add('hidden'));
 document.getElementById(id).classList.remove('hidden');
}

// ------------------- Dashboard -------------------
function loadUI(){
 let u=users[currentUser];
 document.getElementById('dashboard').innerHTML=`
 <h2>Welcome ${currentUser}</h2>
 <img class="avatar" src="https://www.roblox.com/headshot-thumbnail/image?userId=${u.robloxId}&width=150&height=150&format=png">
 <p>Rank: ${u.rankName}</p>
 <p>Role: ${u.role}</p>
 <p>Class: ${u.class}</p>`;
 if(u.role!=='Admin') document.getElementById('adminBtn').style.display='none';
 if(u.role!=='Trainer') document.getElementById('trainerBtn').style.display='none';
 if(u.role==='Admin') loadAdmin();
 if(u.role==='Trainer') loadTrainerPanel();
}

// ------------------- Trainer Panel: Lookup + Rank -------------------
function loadTrainerPanel(){
 let html = `<h2>Trainer Panel - Rank / Grades</h2>
 <input id="lookupUser" placeholder="Enter username to lookup">
 <button onclick="lookupUser()">Lookup</button>
 <div id="lookupResult"></div>`;
 document.getElementById('trainer').innerHTML=html;
}

function lookupUser(){
 let username = document.getElementById('lookupUser').value;
 let u = users[username];
 if(!u){ alert('User not found'); return; }

 // Build rank dropdown
 let rankDropdown = `<select id="newRankSelect">`;
 RANKS.forEach(r=>{
   rankDropdown += `<option value="${r.id}" ${u.rank===r.id?'selected':''}>${r.name}</option>`;
 });
 rankDropdown += `</select>`;

 // Grades input
 let gradeInput = `
 <input id="gradeTitleInput" placeholder="Grade Title">
 <input id="gradeScoreInput" placeholder="Score or Good/Bad">
 <input type="checkbox" id="attendanceInput"> Present
 <button onclick="addGrade('${username}')">Add Grade</button>`;

 // Send to backend for Roblox group (placeholder fetch)
 let rankBtn = `<button onclick="updateRobloxRank('${username}')">Update Roblox Rank</button>`;

 document.getElementById('lookupResult').innerHTML = `
 <p>Username: ${username}</p>
 <p>Current Rank: ${u.rankName}</p>
 <p>Class: ${u.class}</p>
 <p>Change Rank: ${rankDropdown} ${rankBtn}</p>
 ${gradeInput}`;
}

function updateRobloxRank(username){
 let newRankId = parseInt(document.getElementById('newRankSelect').value);
 let newRankName = RANKS.find(r=>r.id===newRankId).name;
 users[username].rank = newRankId;
 users[username].rankName = newRankName;
 save();
 alert(`${username} rank updated locally. Sending to Roblox group...`);

 // Placeholder fetch to backend
 fetch("http://localhost:3000/rank", {
   method:"POST",
   headers: {"Content-Type":"application/json"},
   body: JSON.stringify({
     robloxId: users[username].robloxId,
     groupId:6048775,
     rankId:newRankId
   })
 })
 .then(res=>res.json())
 .then(data=>alert("Rank updated in Roblox group successfully"))
 .catch(err=>console.error("Error updating Roblox rank", err));
}

// ------------------- Grades -------------------
function addGrade(username){
 let title = document.getElementById('gradeTitleInput').value;
 let score = document.getElementById('gradeScoreInput').value;
 let attendance = document.getElementById('attendanceInput').checked?'Present':'Absent';
 if(!grades[username]) grades[username]=[];
 grades[username].push({title, score, attendance, trainer:currentUser, date:new Date().toLocaleDateString()});
 save();
 alert(`Grade added for ${username}`);
}

// ------------------- Chat (Basic) -------------------
function sendMessage(to, content, type='private'){
 messages.push({from:currentUser,to,content,type,date:new Date().toLocaleString()});
 save();
 alert('Message sent');
}
</script>
</body>
</html>
